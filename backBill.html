<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>挂号</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="layui/css/layui.css" media="all">
    <!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
</head>
<style>
    .div {
        margin: auto;
    }
    
    .layui-form-item {
        margin: 0 0px;
        width: 350px;
    }
</style>

<body>
    <form class="layui-form layui-form-pane" action="">
        <br>
        <br>
        <div class="layui-form-item" style="padding-left: 30px">
            <div class="layui-inline">
                <label class="layui-form-label" style="color: white;background-color: #1e9fff;border-color: #1e9fff">冲红发票</label>
                <div class="layui-input-inline">
                    <input style="border-color: #1e9fff" lay-verify="required|bill_id" id="bill_id" id="bill_id" type="text" name="bill_id" autocomplete="off" class="layui-input" required>
                </div>
            </div>

        </div>
        <div class="layui-form-item" style="padding-left: 30px">
            <div class="layui-inline">
                <label class="layui-form-label">病历号码</label>
                <div class="layui-input-inline">
                    <input type="text" lay-verify="required|record_id" id="record_id" name="record_id" autocomplete="off" class="layui-input" required>
                </div>
            </div>
        </div>
        <div class="layui-form-item" style="padding-left: 30px">
            <div class="layui-inline">
                <label class="layui-form-label">患者姓名</label>
                <div class="layui-input-inline">
                    <input type="text" lay-verify="required|name" id="name" name="name" autocomplete="off" class="layui-input" disabled>
                </div>
            </div>

        </div>
        <div class="layui-form-item" style="padding-left: 30px">
            <div class="layui-inline">
                <label class="layui-form-label">应退金额</label>
                <div class="layui-input-inline">
                    <input lay-verify="required|should_pay" id="should_pay" type="text" name="should_pay" autocomplete="off" class="layui-input" style="color: #1e9fff;font-weight: 600;font-size: medium;" disabled>
                </div>
            </div>
        </div>
        <div class="layui-form-item" style="padding-left: 30px">

            <div class="layui-inline layui-hide">
                <label class="layui-form-label" id="back_pay_label">id</label>
                <div class="layui-input-inline">
                    <input lay-verify="required|selected_data" id="selected_data" type="text" name="selected_data" autocomplete="off" class="layui-input" disabled>
                </div>
            </div>
            <div class="layui-inline layui-hide">
                <label class="layui-form-label" id="back_pay_label">user_id</label>
                <div class="layui-input-inline">
                    <input lay-verify="required|user_id" id="user_id" type="text" name="user_id" autocomplete="off" class="layui-input" disabled>
                </div>
            </div>
        </div>
        <div class="layui-form-item layui-hide">
            <input type="button" lay-submit lay-filter="layuiadmin-app-form-submit" id="layuiadmin-app-form-submit" value="确认">
        </div>
    </form>
</body>
<script src="layui/layui.js" charset="utf-8"></script>
<script src="jquery/jquery.min.js"></script>
<script>
    // 接收支付单传的数据
    function child(selected_data, user_id) {
        $('#record_id').val(selected_data[0].record_id);
        $('#name').val(selected_data[0].name);
        $('#user_id').val(user_id);
        var total_price = 0;
        var str = "";
        for (let i = 0; i < selected_data.length; i++) {
            total_price += selected_data[i].price * selected_data[i].num;
            str += selected_data[i].pc_id + "&";
        }
        $('#should_pay').val(total_price);
        $('#selected_data').val(str);
    }
</script>
<script>
    layui.use(['form', 'layedit', 'element', 'table', 'laydate'], function() {
        var form = layui.form,
            layer = layui.layer,
            layedit = layui.layedit,
            element = layui.element,
            table = layui.table,
            $ = layui.jquery,
            laydate = layui.laydate;
        $.ajax({
            url: "http://localhost:8085/pay/initConstants",
            type: 'get',
            contentType: "application/json",
            xhrFields: {
                withCredentials: true
            },
            beforeSend: function() {},
            success: function(data) {
                if (data.code == 1) {
                    layer.msg(data.msg, {
                        icon: 5
                    });
                    return false;
                } else if (data.code == 0) {
                    //初始化发票号
                    $('#bill_id').val(data.data.bill_id[0].name);

                }
            }
        });


        // 【发票单-->确认缴费】
        form.on('submit(layuiadmin-app-form-submit)', function(data) {

            $.ajax({
                url: "http://localhost:8085/back/backPay",
                type: 'post',
                data: JSON.stringify(data.field),
                contentType: "application/json",
                xhrFields: {
                    withCredentials: true
                },
                beforeSend: function() {
                    console.log(data.field);
                },
                success: function(data) {
                    if (data.code == 1) {
                        layer.msg(data.msg, {
                            icon: 5
                        });
                        return false;
                    } else if (data.code == 0) {
                        parent.layer.msg(data.msg, {
                            icon: 6, //成功的表情
                            time: 2000 //1秒关闭（如果不配置，默认是3秒）
                        });
                        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                        parent.layui.table.reload('payment_details', {
                            url: 'http://localhost:8085/back/findPaymentDetailsById',
                            where: {
                                id: $('#record_id').val()
                            }
                        }); //只重载数据
                        parent.layer.close(index);
                    }
                }
            })

        });

    });
</script>

</html>